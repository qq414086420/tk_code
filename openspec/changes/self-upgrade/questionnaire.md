# 自升级框架设计调研问卷

请在以下问题中填写答案，完成后我将基于此完善 proposal。

## 1. Web 服务部署

**技术栈**：
- Web 服务语言：Java
- Web 服务语言：Python
- 部署方式：传统进程部署（非容器化）

**补充问题**：
- Web 服务是否通过 systemd/supervisor 等进程管理工具管理？
- Web 服务的安装目录结构是什么样的？
- Java 服务和 Python 服务的关系是什么？是独立服务还是 Java 调用 Python 脚本？
- 服务已注册systemd;本次设计中先不关心服务安装的目录结构;java服务在处理业务时会调用python在本地的监听端口，但是这个架构对现阶段设计影响较小，因为实际升级软件的过程中python和java都是一起进行升级的。

---

## 2. 升级策略

**补充问题**：
- 是否要求零停机升级？（是/否）
- 可接受的最长停机时间是多少？（秒/分钟）
- 主备节点升级顺序偏好：
  - A. 滚动升级（先升级备节点，验证通过后再升级主节点）
  - B. 停机升级（先停止主节点，升级后切换 VIP）
  - C. 其他方式，请说明：______
- 升级期间是否可以短暂接受只读模式？（是/否）
- 不能停机升级; 停机时间在4分钟以内，当前服务启动的时间基线是2分钟；滚动升级，升级中间切换VIP。

---

## 3. 升级包来源

**补充问题**：
- 升级包获取方式：
  - A. 内部 Git 仓库
  - B. 内部制品仓库（Nexus/Artifactory 等）
  - C. 文件服务器（HTTP/FTP）
  - D. 其他，请说明：______
- 升级包格式：（jar 包、tar.gz、zip、docker 镜像、其他？）
- 版本号格式：（例如：v1.0.0, 2025.01.01, 1.0.0.1234？）
- 当前发布流程是手动还是自动化？
- 升级包是否包含数字签名或校验和？（是/否）
- 当前由用户手动上传升级包到指定路径，然后调用一个分发升级包的接口对升级包进行解压并分发；升级包版本号格式以及发布形式在当前阶段不重要；升级包包含数字签名；

---

## 4. 配置同步机制（rsync）

**已知信息**：
- 使用 rsync 同步主备节点的配置文件

**补充问题**：
- rsync 同步的频率如何？（实时/定时，间隔多久？）
- rsync 同步哪些配置文件？（请列出关键配置文件路径）
- rsync 是双向同步还是单向（主→备）？
- 升级过程中是否需要暂停 rsync 以避免覆盖新版本配置？
  - 如果是，暂停的时机和恢复的时机是什么？
- 5分钟；同步的配置文件较多，并且较为复杂，先关注抽象层次，其中有一个根密钥配置比较重要，其他作为抽象结构；单向同步；升级过程中需要暂停rsync，我计划在触发升级节点后立刻中断文件同步，待两个节点都升级完毕后再恢复。

---

## 5. Keepalived VIP 切换

**已知信息**：
- 使用 keepalived 进行主备仲裁

**补充问题**：
- keepalived 配置的主备切换策略是什么？（优先级/脚本检测？）
- 升级过程中是否需要手动触发 VIP 切换？
- VIP 切换的超时时间是多少？
- 升级失败时，如何自动切换回原主节点？
- 主备切换策略是脚本检测，脚本检测逻辑为检查vip，然后检查监听端口；升级过程中VIP需要切换，但我不确定能否手动控制，亦或是只能依靠keepalive机制切换；VIP切换超时时间未知，不过可以修改；升级失败时不需要切回主节点，尽量保持接口可用，以供回退接口调用。

---

## 6. GaussDB 数据库处理

**已知信息**：
- 本地部署主备 GaussDB
- 通过 gaussdb-kernel 建立主备同步关系

**补充问题**：
- Web 服务升级时是否涉及 GaussDB 的 schema 变更？
  - 如果是，schema 变更的频率如何？
  - schema 变更与代码升级的先后顺序是什么？
- GaussDB 是否需要独立升级？（与 web 服务解耦升级）
- 数据库升级时的停机策略是什么？（主备切换、在线升级、停机升级？）
- Web 服务如何连接数据库？（JDBC/其他，连接池配置？）
- 升级期间是否需要数据库迁移脚本？
- 我不理解schema变更是什么，是指表字段吗？当前设计方案是在执行节点升级前触发表字段更新，这里添加约束，每次升级时的表字段变化需要向后兼容，即高版本的sql不能影响低版本正常运行;gaussdb与服务升级不解耦；我的策略是先升备节点的gaussdb,待触发vip倒换后原备节点db会升主，此时再升原主节点db;web服务连接db的方式不重要，升级不会改变这个机制；升级期间不需要数据库迁移脚本。

---

## 7. 健康检查机制

**补充问题**：
- 当前系统已有哪些健康检查探针？
  - [ ] 数据库连接检查
  - [ ] 服务端口检查
  - [ ] HTTP 接口健康检查（请提供接口路径）
  - [ ] Keepalived 心跳检测
  - [ ] 其他，请说明：______
- 升级成功的判断标准是什么？
  - 服务启动成功？
  - 健康检查全部通过？
  - 数据库连接正常？
  - 业务接口返回正常？
  - 其他？
- 升级失败的判断标准是什么？
  - 服务启动失败？
  - 健康检查超时？
  - 数据库连接失败？
  - 其他？
- 当前仅有服务端口检查，keepalived心跳检查；这个模块的其余部分你来帮我设计。

---

## 8. 回滚机制

**补充问题**：
- 当前是否有备份机制？
  - [ ] 代码备份（保留旧版本包）
  - [ ] 配置备份
  - [ ] 数据库备份（全量/增量，备份周期？）
  - [ ] 其他，请说明：______
- 回滚时是否需要保留新版本数据迁移的变更？
- 回滚策略：
  - A. 自动回滚（检测到失败后自动回滚）
  - B. 手动回滚（人工介入后回滚）
  - C. 半自动（自动检测，人工确认后回滚）
- 回滚的超时时间是多少？
- 无稳态的备份机制，需要升级前进行备份。回滚策略为手动回滚。

---

## 9. 系统环境

**补充问题**：
- 操作系统版本：______
- Java 版本：______
- Python 版本：______
- GaussDB 版本：______
- Keepalived 版本：______
- 网络架构（是否有防火墙、负载均衡器等）：______
- 是否支持离线环境？（是/否，如果有离线需求，如何获取升级包？）
- 这些先不重要，抽象考虑即可。

---

## 10. 其他需求

**补充问题**：
- 是否有审计日志要求？（记录升级操作、用户、时间等）
- 是否有通知机制需求？（升级成功/失败时通知管理员）
- 是否有灰度发布需求？（部分节点先升级）
- 是否有并发限制？（同一时间只能有一个升级任务）
- 其他特殊需求或限制：______
- 无

---

**填写说明**：
- 在 [你的答案...] 处填写你的回答
- 可以删除不适用的问题
- 如果不确定某些问题，可以标记为"待确认"
