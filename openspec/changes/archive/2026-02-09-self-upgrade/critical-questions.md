# 自升级框架设计 - 必须确认的关键问题

以下问题对设计阶段至关重要，请务必回答。

---

## 问题 1: Keepalived VIP 切换控制

**背景信息**：
- 升级过程中VIP需要切换
- 不确定能否手动控制，亦或是只能依靠keepalive机制切换

**为什么必须确认**：
- 这决定了升级流程的控制方式
- 如果只能依赖自动切换，需要考虑超时配置和状态同步问题
- 如果可以手动控制，可以精确控制切换时机，减少服务中断风险

**问题**：
1. 是否可以手动触发 Keepalived 的 VIP 切换？（例如通过命令行或 API）
   - [ ] 可以，方式是：____________________
   - [ ] 不可以，只能依赖 Keepalived 自动切换
   - [x] 不清楚

2. 如果可以手动切换，请提供切换命令或接口：____________________

3. 如果只能自动切换，是否可以配置 Keepalived 的优先级来实现控制切换？
   - [ ] 可以
   - [ ] 不可以
   - [x] 不清楚

4. 请提供 Keepalived 配置文件路径或相关配置：
暂无

请查询keepalived相关文档设计相关行为。
---

## 问题 2: 升级超时控制

**背景信息**：
- VIP 切换超时时间未知，但可以修改
- 停机时间要求：4分钟以内
- 服务启动基线时间：2分钟

**为什么必须确认**：
- 滚动升级需要在超时前完成每个节点的升级和验证
- 需要定义升级失败的超时阈值，触发回滚流程
- 影响用户体验和系统可用性承诺

**问题**：
1. 单个节点的升级超时时间建议是多少？
   - 建议：___15___ 分钟（建议值：2.5-3分钟，考虑服务启动基线2分钟）

2. VIP 切换的超时时间建议是多少？
   - 建议：___30___ 秒（建议值：30-60秒）

3. 健康检查的超时阈值建议是多少？
   - 建议：___30___ 秒（建议值：10-30秒）

4. 升级失败后，多久触发回滚？
   - 建议：________ 秒（建议值：立即或30秒内）
   不触发自动回滚，仅报出失败，由用户手动点回滚

---

## 问题 3: 健康检查接口设计

**背景信息**：
- 当前仅有服务端口检查
- 有 keepalived 心跳检查
- 其余部分需要设计

**为什么必须确认**：
- 健康检查是判断升级是否成功的关键
- 需要设计足够全面的检查项来确保服务可用性

**问题**：
1. 建议的健康检查接口路径是什么？
   - [x] /health
   - [ ] /api/health
   - [ ] 其他：____________________

2. 建议的健康检查项（请勾选或补充）：
   - [x] 数据库连接检查（必须）
   - [x] 服务端口检查（已有）
   - [x] Keepalived 心跳检查（已有）
   - [ ] 关键业务接口检查（请提供示例接口路径）：____________________
   - [ ] 配置文件完整性检查（包括根密钥配置）
   - [ ] 服务内存/CPU使用率检查
   - [ ] 日志错误检查（检查最近N分钟是否有ERROR日志）
   - [ ] 其他：____________________

3. 升级成功的判断标准是什么？
   - [x] 服务启动成功
   - [x] 所有健康检查项通过
   - [ ] 持续时间内无异常（请说明）：例如30秒内检查3次全部通过
   - [ ] 其他：____________________

4. 升级失败的判断标准是什么？
   - [x] 服务启动失败
   - [x] 健康检查超时
   - [x] 数据库连接失败
   - [x] 业务接口返回错误
   - [ ] 其他：____________________

---

## 问题 4: 升级前备份范围

**背景信息**：
- 无稳态的备份机制
- 需要升级前进行备份
- 回滚策略为手动回滚

**为什么必须确认**：
- 手动回滚需要依赖备份文件
- 需要明确备份范围以设计备份流程和存储策略
- 影响回滚的可行性和数据安全性

**问题**：
1. 需要备份的内容（请勾选）：
   - [x] 代码包（jar 包）
   - [ ] 代码包（Python 脚本）
   - [x] 配置文件（具体是哪些？）：有一个根密钥必须备份，因为当前升级方式会安装高版本软件，安装过程中会生成随机的根密钥覆盖老版本的，此时需要使用备份中低版本根密钥恢复回来
   - [x] 数据库（请说明是全量还是增量？）：全量
   - [ ] 其他：____________________

2. 备份文件保存在什么位置？
   - [ ] 本地目录（请提供路径）：____________________
   - [ ] 远程存储（例如：NFS、对象存储等）
   - [ ] 其他：_不重要_________________

3. 备份保留周期是多少？
   - [x] 保留最近 1 次升级的备份
   - [ ] 保留最近 N 次升级的备份（N = ____）
   - [ ] 保留最近 N 天的备份（N = ____）
   - [ ] 其他：________________

4. 备份文件命名规则建议是什么？
   - [x] 按时间戳：backup_20250107_143025
   - [ ] 按版本号：backup_v1.0.0_to_v1.1.0
   - [ ] 其他：______________

---

## 补充说明

请在上述问题中选择或填写答案。如果有不确定的地方，可以标记为"待确认"。

**注意**：
- 带有"建议值"的问题，如果您没有明确需求，可以采用建议值
- 如果某些问题的答案涉及多个选项，请全部勾选
- 如果需要补充说明，请在相应问题的空白处填写
