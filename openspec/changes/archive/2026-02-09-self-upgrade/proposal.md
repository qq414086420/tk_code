## Why

当前主备高可用的 web 服务系统缺乏自动化升级能力。系统管理员需要在两个节点上手动执行升级操作，人工控制 VIP 切换和数据库升级顺序，升级成功/失败判断也依赖人工验证。这种手动操作方式存在以下问题：

1. **升级效率低**：需要手动在主备节点分别操作，流程复杂且容易出错
2. **服务中断风险高**：人工干预难以精确控制停机时间，可能超过 4分钟的要求
3. **缺乏统一的健康检查**：没有标准化的升级成功/失败判断机制
4. **备份和回滚不规范**：没有标准化的备份流程，回滚操作风险较高
5. **配置同步冲突**：升级过程中 rsync 可能导致新旧配置冲突

建立一套自升级框架，实现主备节点的滚动升级、VIP 自动切换、健康检查和备份回滚，可以显著提升升级效率、降低风险、确保服务连续性。

**重要说明**：
- 本变更处于设计阶段，输出为设计视图、接口定义、流程图、配置示例等设计文档
- 不涉及编码实现，仅完成系统自升级特性的设计工作
- 设计成果将指导后续的开发工作，当前没有项目代码可供实施

---

## What Changes

- 实现主备节点滚动升级流程（先升级备节点，验证通过后再升级主节点）
- 集成 Keepalived VIP 切换控制，通过 priority 调整自动触发切换
- 提供标准化的 `/health` 健康检查接口，覆盖数据库连接、服务端口、Keepalived 心跳
- 建立升级前自动备份机制（代码包、配置文件、数据库）
- 支持手动回滚功能，失败仅报错不自动回滚
- 升级过程中协调 rsync 同步（暂停/恢复），避免配置冲突
- 实现 GaussDB 主备同步升级（先备后主，schema 向后兼容）
- 支持升级进度实时监控和日志记录

---

## Capabilities

### New Capabilities

- `rolling-upgrade`: 滚动升级流程管理
  - 在主备节点间自动协调升级顺序（先备后主）
  - 控制升级总时间在 4分钟以内
  - 处理升级失败和超时情况

- `health-check`: 统一健康检查机制
  - 提供 `/health` HTTP 接口
  - 检查项：数据库连接、服务端口、Keepalived 心跳
  - 自动判断升级成功/失败

- `backup-rollback`: 备份和回滚管理
  - 升级前自动备份：代码包（jar）、配置文件（根密钥）、数据库（全量）
  - 保留最近 1 次升级的备份，按时间戳命名
  - 手动触发回滚，失败仅报错不自动回滚

- `keepalived-control`: VIP 切换控制
  - 通过调整 Keepalived priority 实现手动触发 VIP 切换
  - 升级失败时保持接口可用，以供回退接口调用
  - 配置 VIP 切换超时（30秒）

- `config-sync-coordinator`: 配置同步协调
  - 升级触发后立即暂停 rsync 同步
  - 两个节点升级完成后恢复 rsync
  - 避免新版本配置被旧版本覆盖

- `database-upgrade`: 数据库升级管理
  - GaussDB 主备同步升级（先备后主）
  - 支持 schema 变更，强制要求向后兼容
  - 升级前全量备份数据库

- `api-interfaces`: Web 升级接口定义
  - 升级触发接口（POST /api/v1/upgrade/trigger）
  - 升级进度查询接口（GET /api/v1/upgrade/progress/{upgrade_id}）
  - 回滚触发接口（POST /api/v1/upgrade/rollback/{upgrade_id}）
  - 升级任务取消接口（POST /api/v1/upgrade/cancel/{upgrade_id}）
  - 升级历史查询接口（GET /api/v1/upgrade/history）
  - 升级日志查询接口（GET /api/v1/upgrade/logs/{upgrade_id}）

### Modified Capabilities

- 无现有能力需要变更规格级别的要求

---

## Impact

**设计输出**：
本变更的最终输出为系统自升级特性的完整设计视图，包括：

- **架构设计视图**：
  - 滚动升级流程的状态机图
  - 主备节点交互时序图
  - 系统组件依赖关系图

- **接口设计文档**：
  - `/health` 健康检查接口规范（HTTP 方法、路径、请求/响应格式）
  - 升级触发接口规范（升级包上传、参数定义、返回值）
  - 升级进度查询接口规范（状态码定义、进度字段）
  - 回滚触发接口规范（参数定义、返回值）

- **流程设计文档**：
  - 升级前准备流程（备份、预检查）
  - 滚动升级执行流程（备节点 → VIP 切换 → 主节点）
  - 回滚执行流程
  - 异常处理流程

- **配置设计**：
  - 升级配置项定义（超时时间、健康检查参数、备份保留周期等）
  - Keepalived priority 调整方案
  - rsync 暂停/恢复策略

- **数据库设计**：
  - 升级历史记录表结构（记录升级时间、版本、状态、日志）
  - 备份记录表结构（备份文件路径、时间戳、完整性校验）

**核心组件影响**:
  - Web 服务（Java + Python）：需要新增 `/health` 健康检查接口
  - GaussDB：需要支持 schema 向后兼容和主备同步升级
  - Keepalived：需要支持 priority 动态调整
  - rsync：需要在升级流程中暂停/恢复

**新增接口**:
  - `/health`：健康检查接口
  - 升级触发接口：接收用户上传的升级包，启动升级流程
  - 升级进度查询接口：实时返回升级状态
  - 回滚触发接口：手动触发回滚操作

**配置文件**:
  - 升级配置：升级超时时间、健康检查参数、备份保留周期等

**部署流程**:
  - 升级前自动备份
  - 滚动升级（先备后主）
  - VIP 自动切换
  - 健康检查验证
  - rsync 暂停/恢复协调

**外部依赖**:
  - 可能需要添加备份工具（数据库备份、文件备份）
  - 可能需要添加 HTTP 客户端库（健康检查、进度接口）
  - 可能需要添加 Keepalived 配置管理工具

**用户文档**:
  - 升级操作指南
  - 回滚操作指南
  - 故障排查手册
  - API 接口文档

**运维流程**:
  - 升级前备份检查
  - 升级过程监控
  - 升级后验证
  - 回滚处理流程
